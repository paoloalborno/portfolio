<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="cv.title">CV - Paolo Alborno</title>
    <meta name="description" content="CV Interattivo di Paolo Alborno" data-translate-key="cv.meta_description">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Styles for this page specifically */
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding-top: 80px; /* Header height */
        }
        .cv-graph-container {
            width: 100%;
            flex-grow: 1;
            position: relative;
            background-color: #1a202c; /* Dark theme background */
        }
        #cv-graph {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="cv-graph-container">
            <div id="cv-graph"></div>
            <div id="cv-legend" class="cv-legend"></div>
        </div>
    </main>

    <!-- Modal Structure (hidden by default) -->
    <div id="cv-modal" class="cv-modal">
        <div class="cv-modal-content">
            <span class="cv-modal-close-btn">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-company"></p>
            <p id="modal-date"></p>
            <div id="modal-details"></div>
            <div id="modal-link-container"></div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="//unpkg.com/force-graph"></script>
    <script src="js/cv_data.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/main.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIGURATION ---
        const graphColors = {
            core: '#667eea',
            category: '#764ba2',
            experience: '#f5576c',
            education: '#f093fb',
            certs: '#4facfe',
            skill: '#a0aec0',
            future: '#00f2fe'
        };
        const FONT_FAMILY = 'Inter, Sans-Serif';

        // --- DATA PROCESSING ---
        const gData = { nodes: [], links: [] };
        // Create a map for quick node lookup
        const nodeMap = new Map();

        // Add core node
        const mainNode = { id: 'Paolo Alborno', group: 'core', val: 12, level: 0 };
        gData.nodes.push(mainNode);
        nodeMap.set(mainNode.id, mainNode);

        // Define categories
        const categories = {
            experience: 'Esperienze',
            education: 'Istruzione',
            certifications: 'Certificazioni',
            skills: 'Competenze',
            future_goals: 'Obiettivi Futuri'
        };

        // Create category nodes and link them to the core
        Object.entries(categories).forEach(([key, title]) => {
            const categoryNode = { id: title, group: 'category', val: 8, level: 1 };
            gData.nodes.push(categoryNode);
            nodeMap.set(title, categoryNode);
            gData.links.push({ source: mainNode.id, target: title });
        });

        // Process all items from cvData to create nodes and links
        Object.entries(cvData).forEach(([key, items]) => {
            items.forEach(item => {
                const nodeTitle = item.title || item.id;
                if (!nodeMap.has(nodeTitle)) {
                    const node = {
                        ...item,
                        id: nodeTitle,
                        group: item.group || key,
                        val: item.val || 6,
                        level: 2
                    };
                    gData.nodes.push(node);
                    nodeMap.set(nodeTitle, node);

                    // Link item to its category
                    if (categories[key]) {
                        gData.links.push({ source: categories[key], target: nodeTitle });
                    }
                }

                // Link item to its skills
                if (item.skills) {
                    item.skills.forEach(skillName => {
                        if (!nodeMap.has(skillName)) {
                            const skillNode = { id: skillName, group: 'skill', val: 4, level: 3 };
                            gData.nodes.push(skillNode);
                            nodeMap.set(skillName, skillNode);
                            gData.links.push({ source: categories.skills, target: skillName });
                        }
                        gData.links.push({ source: nodeTitle, target: skillName });
                    });
                }
            });
        });

        // --- MODAL SETUP ---
        const modal = document.getElementById('cv-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCompany = document.getElementById('modal-company');
        const modalDate = document.getElementById('modal-date');
        const modalDetails = document.getElementById('modal-details');
        const modalLinkContainer = document.getElementById('modal-link-container');
        const closeModalBtn = document.querySelector('.cv-modal-close-btn');

        closeModalBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // --- LEGEND SETUP ---
        const legendContainer = document.getElementById('cv-legend');
        const legendMapping = {
            'Esperienze': 'experience', 'Istruzione': 'education', 'Certificazioni': 'certs',
            'Competenze': 'skill', 'Obiettivi Futuri': 'future'
        };
        for (const [title, group] of Object.entries(legendMapping)) {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `<div class="legend-color-box" style="background-color: ${graphColors[group]}"></div><span>${title}</span>`;
            legendContainer.appendChild(item);
        }

        // --- GRAPH INITIALIZATION ---
        const Graph = ForceGraph()(document.getElementById('cv-graph'))
            .graphData(gData)
            .nodeId('id')
            .nodeVal('val')
            .nodeLabel('') // Disable default tooltip
            .nodeAutoColorBy('group', d => graphColors[d.group])
            .linkColor(() => 'rgba(255, 255, 255, 0.2)')
            .linkWidth(1)
            .backgroundColor('rgba(0,0,0,0)')
            .enableZoomInteraction(false) // Disable zoom
            .enablePanInteraction(false) // Disable pan
            .onNodeClick(node => {
                // Find the full data object for the clicked node
                const nodeData = Object.values(cvData).flat().find(item => (item.id === node.id) || (item.title === node.id));
                if (!nodeData) return;

                // Populate and show the modal
                modalTitle.textContent = nodeData.title || nodeData.id;
                modalCompany.textContent = nodeData.company || '';
                modalDate.textContent = nodeData.date || '';

                modalDetails.innerHTML = '';
                if (nodeData.details && nodeData.details.length > 0) {
                    const ul = document.createElement('ul');
                    nodeData.details.forEach(d => {
                        const li = document.createElement('li');
                        li.innerHTML = d;
                        ul.appendChild(li);
                    });
                    modalDetails.appendChild(ul);
                }

                modalLinkContainer.innerHTML = '';
                if (nodeData.link) {
                    const a = document.createElement('a');
                    a.href = nodeData.link;
                    a.target = '_blank';
                    a.textContent = 'Vedi Progetti Correlati';
                    a.className = 'btn btn-primary';
                    a.style.marginTop = '1rem';
                    modalLinkContainer.appendChild(a);
                }

                modal.style.display = 'block';
            })
            .nodeCanvasObject((node, ctx, globalScale) => {
                // Draw the node as a circle
                const radius = Math.sqrt(node.val) * 2;
                ctx.beginPath();
                ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI, false);
                ctx.fillStyle = graphColors[node.group] || '#cccccc';
                ctx.fill();

                // Draw the label next to the node
                const label = node.id;
                const fontSize = 14 / globalScale;
                ctx.font = `${fontSize}px ${FONT_FAMILY}`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fillText(label, node.x + radius + 3, node.y);
            });

        // Set graph forces for a stable layout
        Graph.d3Force('charge').strength(-150);
        Graph.d3Force('link').distance(60);
        Graph.d3Force('center', d3.forceCenter());
    });
    </script>
</body>
</html>
