<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="cv.title"></title>
    <meta name="description" content="" data-translate-key="cv.meta_description">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Styles for this page specifically */
        .cv-graph-container {
            width: 100%;
            height: calc(100vh - 80px); /* Full viewport height minus header */
            position: relative;
        }
        #cv-graph {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="cv-graph-container">
            <div id="cv-graph"></div>
            <div id="cv-legend" class="cv-legend">
                <!-- Legend will be generated by JS or static -->
            </div>
        </div>
    </main>

    <!-- Modal Structure (hidden by default) -->
    <div id="cv-modal" class="cv-modal">
        <div class="cv-modal-content">
            <span class="cv-modal-close-btn">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-company"></p>
            <p id="modal-date"></p>
            <div id="modal-details"></div>
            <div id="modal-link-container"></div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="//unpkg.com/force-graph"></script>
    <script src="js/cv_data.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/main.js"></script>

    <!-- Graph and Modal logic -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const graphColors = {
            core: '#5a67d8',
            category: '#667eea',
            experience: '#764ba2',
            education: '#764ba2',
            certs: '#f5576c',
            skill: '#4facfe',
            future: '#00f2fe'
        };

        // --- 1. Generate Graph Data ---
        const gData = { nodes: [], links: [] };
        const mainNode = { id: 'Paolo Alborno', group: 'core', val: 5 };
        gData.nodes.push(mainNode);

        const categories = {
            experience: 'Esperienze', education: 'Istruzione', certifications: 'Certificazioni',
            skills: 'Competenze', future_goals: 'Obiettivi Futuri'
        };

        Object.entries(categories).forEach(([key, title]) => {
            gData.nodes.push({ id: title, group: 'category', val: 4 });
            gData.links.push({ source: mainNode.id, target: title });
        });

        Object.entries(cvData).forEach(([key, items]) => {
            if (key === 'skills' || key === 'future_goals') {
                items.forEach(item => {
                    gData.nodes.push(item);
                    gData.links.push({ source: categories[key], target: item.id });
                });
            } else {
                items.forEach(item => {
                    gData.nodes.push({ ...item, group: key, val: 3 });
                    gData.links.push({ source: categories[key], target: item.title });
                    if (item.skills) {
                        item.skills.forEach(skillName => {
                            gData.links.push({ source: item.title, target: skillName });
                        });
                    }
                });
            }
        });

        // --- 2. Setup Modal ---
        const modal = document.getElementById('cv-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCompany = document.getElementById('modal-company');
        const modalDate = document.getElementById('modal-date');
        const modalDetails = document.getElementById('modal-details');
        const modalLinkContainer = document.getElementById('modal-link-container');
        const closeModalBtn = document.querySelector('.cv-modal-close-btn');

        closeModalBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // --- 3. Setup Legend ---
        const legendContainer = document.getElementById('cv-legend');
        const legendMapping = {
            'Esperienze': 'experience', 'Istruzione': 'education', 'Certificazioni': 'certs',
            'Competenze': 'skill', 'Obiettivi Futuri': 'future'
        };
        for (const [title, group] of Object.entries(legendMapping)) {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `<div class="legend-color-box" style="background-color: ${graphColors[group]}"></div><span>${title}</span>`;
            legendContainer.appendChild(item);
        }

        // --- 4. Initialize Graph ---
        const Graph = ForceGraph()(document.getElementById('cv-graph'))
            .graphData(gData)
            .nodeId('id')
            .nodeVal('val')
            .nodeLabel(node => `${node.group}: ${node.id}`)
            .nodeAutoColorBy('group')
            .linkColor(() => 'rgba(45, 55, 72, 0.2)')
            .linkWidth(1)
            .enableZoomInteraction(false)
            .enablePanInteraction(false)
            .onNodeClick(node => {
                const nodeData = Object.values(cvData).flat().find(item => item.id === node.id || item.title === node.id);
                if (!nodeData || !nodeData.details) return;

                modalTitle.textContent = nodeData.title || '';
                modalCompany.textContent = nodeData.company || '';
                modalDate.textContent = nodeData.date || '';

                modalDetails.innerHTML = '';
                if (nodeData.details.length > 0) {
                    const ul = document.createElement('ul');
                    nodeData.details.forEach(d => {
                        const li = document.createElement('li');
                        li.innerHTML = d; // Use innerHTML to render bold tags if any
                        ul.appendChild(li);
                    });
                    modalDetails.appendChild(ul);
                }

                modalLinkContainer.innerHTML = '';
                if (nodeData.link) {
                    const a = document.createElement('a');
                    a.href = nodeData.link;
                    a.textContent = 'Vedi Progetti Correlati';
                    a.className = 'btn btn-primary';
                    a.style.marginTop = '1rem';
                    modalLinkContainer.appendChild(a);
                }

                modal.style.display = 'block';
            })
            .nodeCanvasObject((node, ctx, globalScale) => {
                const label = node.id;
                const fontSize = 12 / globalScale;
                ctx.font = `600 ${fontSize}px Sans-Serif`;

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = graphColors[node.group] || '#2d3748';

                const r = Math.sqrt(node.val) * 4 / globalScale;
                ctx.beginPath();
                ctx.arc(node.x, node.y, r, 0, 2 * Math.PI, false);
                ctx.fill();

                // Add text label if node is large enough
                if (node.val > 2) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fillText(label, node.x, node.y);
                }
            });

        // Stabilize graph
        Graph.d3Force('charge').strength(-120);
        Graph.d3Force('link').distance(40);
        Graph.d3Force('center', d3.forceCenter());
    });
    </script>
</body>
</html>
