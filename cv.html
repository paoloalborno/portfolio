<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="cv.title"></title>
    <meta name="description" content="" data-translate-key="cv.meta_description">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .highlight-entry {
            background-color: rgba(102, 126, 234, 0.1);
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <section class="cv-page" style="padding-top: 120px;">
            <div class="container">
                <div class="cv-header" data-aos="fade-in">
                    <h1 class="cv-title" data-translate-key="cv.main_title">Curriculum Vitae</h1>
                    <p class="cv-subtitle" data-translate-key="cv.main_subtitle">Un percorso professionale nel mondo del software e dei dati.</p>
                </div>

                <div class="cv-grid-container">
                    <div class="cv-left-column" id="cv-text-container">
                        <!-- Content will be generated by JavaScript -->
                    </div>
                    <div class="cv-right-column">
                        <div id="cv-graph"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="//unpkg.com/force-graph"></script>
    <script src="js/cv_data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init({
                duration: 800,
                once: true
            });

            // --- 1. Generate CV Text from Data ---
            const cvContainer = document.getElementById('cv-text-container');
            const sections = {
                experience: { title: 'Esperienze Lavorative', 'data-translate-key': 'cv.work_experience_title' },
                education: { title: 'Istruzione e Formazione', 'data-translate-key': 'cv.education_title' },
                certifications: { title: 'Certificazioni', 'data-translate-key': 'cv.certifications_title' }
            };

            for (const sectionKey in sections) {
                const sectionData = cvData[sectionKey];
                if (sectionData && sectionData.length > 0) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'cv-section';
                    sectionDiv.setAttribute('data-aos', 'fade-up');

                    const title = document.createElement('h2');
                    title.className = 'cv-section-title';
                    title.textContent = sections[sectionKey].title;
                    title.setAttribute('data-translate-key', sections[sectionKey]['data-translate-key']);
                    sectionDiv.appendChild(title);

                    sectionData.forEach(item => {
                        const entryDiv = document.createElement('div');
                        entryDiv.className = 'cv-entry';
                        entryDiv.id = item.id;

                        let entryHTML = `
                            <div class="cv-entry-header">
                                <h3 class="cv-entry-title">${item.title}</h3>
                                ${item.date ? `<span class="cv-entry-date">${item.date}</span>` : ''}
                            </div>
                            ${item.company ? `<p class="cv-entry-company">${item.company}</p>` : ''}
                        `;

                        if (item.details && item.details.length > 0) {
                            entryHTML += `<div class="cv-entry-details"><ul>`;
                            item.details.forEach(detail => {
                                entryHTML += `<li>${detail}</li>`;
                            });
                            entryHTML += `</ul></div>`;
                        }

                        entryDiv.innerHTML = entryHTML;
                        sectionDiv.appendChild(entryDiv);
                    });
                    cvContainer.appendChild(sectionDiv);
                }
            }

            // --- 2. Generate Graph Data from CV Data ---
            const gData = { nodes: [], links: [] };
            const mainNode = { id: 'Paolo Alborno', group: 'core', val: 5 };
            gData.nodes.push(mainNode);

            const allSections = {
                ...sections,
                skills: { title: 'Competenze' },
                future_goals: { title: 'Obiettivi Futuri' }
            };

            for (const sectionKey in allSections) {
                const sectionTitle = allSections[sectionKey].title;
                gData.nodes.push({ id: sectionTitle, group: 'category', val: 4 });
                gData.links.push({ source: mainNode.id, target: sectionTitle });
            }

            ['experience', 'education', 'certifications'].forEach(sectionKey => {
                cvData[sectionKey].forEach(item => {
                    gData.nodes.push({ id: item.title, group: sectionKey, val: 3, refId: item.id });
                    gData.links.push({ source: allSections[sectionKey].title, target: item.title });
                    if (item.skills) {
                        item.skills.forEach(skillName => {
                            gData.links.push({ source: item.title, target: skillName });
                        });
                    }
                });
            });

            cvData.skills.forEach(skill => {
                gData.nodes.push(skill);
                gData.links.push({ source: allSections.skills.title, target: skill.id });
            });

            cvData.future_goals.forEach(goal => {
                gData.nodes.push(goal);
                gData.links.push({ source: allSections.future_goals.title, target: goal.id });
            });

            // --- 3. Initialize Graph with Interactivity ---
            const graphColors = {
                core: '#5a67d8',
                category: '#667eea',
                experience: '#764ba2',
                education: '#764ba2',
                certs: '#f5576c',
                skill: '#4facfe',
                future: '#00f2fe'
            };

            let highlightedElement = null;

            const Graph = ForceGraph()
                (document.getElementById('cv-graph'))
                .graphData(gData)
                .nodeId('id')
                .nodeVal('val')
                .nodeLabel('id')
                .nodeAutoColorBy('group')
                .linkColor(() => 'rgba(45, 55, 72, 0.2)')
                .linkWidth(1)
                .onNodeHover(node => {
                    if (highlightedElement) {
                        highlightedElement.classList.remove('highlight-entry');
                        highlightedElement = null;
                    }
                    if (node && node.refId) {
                        const el = document.getElementById(node.refId);
                        if (el) {
                            el.classList.add('highlight-entry');
                            highlightedElement = el;
                        }
                    }
                })
                .nodeCanvasObject((node, ctx, globalScale) => {
                    const label = node.id;
                    const fontSize = 12 / globalScale;
                    ctx.font = `600 ${fontSize}px Sans-Serif`;

                    const textWidth = ctx.measureText(label).width;
                    const bckgDimensions = [textWidth, fontSize].map(n => n + fontSize * 0.4); // padding

                    // Draw background rectangle
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.strokeStyle = graphColors[node.group] || '#2d3748';
                    ctx.lineWidth = 2 / globalScale;

                    // Rounded rectangle
                    const r = 4 / globalScale;
                    const x = node.x - bckgDimensions[0] / 2;
                    const y = node.y - bckgDimensions[1] / 2;
                    const w = bckgDimensions[0];
                    const h = bckgDimensions[1];
                    ctx.beginPath();
                    ctx.moveTo(x + r, y);
                    ctx.lineTo(x + w - r, y);
                    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                    ctx.lineTo(x + w, y + h - r);
                    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                    ctx.lineTo(x + r, y + h);
                    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                    ctx.lineTo(x, y + r);
                    ctx.quadraticCurveTo(x, y, x + r, y);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();

                    // Draw text
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = graphColors[node.group] || '#2d3748';
                    ctx.fillText(label, node.x, node.y);
                });
        });
    </script>
    <script src="js/translations.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
